This directory contains tools to run and evaluate the p4 code generated by needlstk.

To run:
- Make sure that your virtual ethernet interfaces are set up:
```
$> $BMV2PATH/tools/veth_setup.sh
```
- Compile autogenerated code (located at $AUTOGEN_P4) with p4c:
```
$P4CPATH/build/p4c-bm2-ss $AUTOGEN_P4 -o $JSON_TARGET
```
- Start the simple_switch target with the autogenerated p4 code:
```
$> sudo $BMV2PATH/targets/simple_switch/simple_switch -i 0@veth2 1@veth4 --log-file switch.log --log-flush --pcap $JSON_TARGET
```
Note that --pcap creates two pcap files (named veth2.pcap and veth4.pcap) for every switch it sends out of ports 0 and 1, respectively.
To run traffic from pre-existing pcap files, add the `--use-files 0` flag and place the input packets into veth2_in.pcap and veth4_in.pcap.

- If not using input pcap files, run traffic through the switch, i.e. `sudo python gen_sample_traffic.py`. This can also be done from the
scapy interactive shell if you're only sending a few packets.

- Read the registers out using BMV2s provided CLI.
```
./get_register_values.sh $REGISTER_NAME
```
where `$REGISTER_NAME` is the name of the register you want to read, according to the p4 code. This script will print out the indices of this register with a non-zero value.
