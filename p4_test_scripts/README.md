This directory contains tools to run and evaluate the p4 code generated by needlstk.

To run:
- Make sure that your virtual ethernet interfaces are set up:
```
$> $BMV2PATH/tools/veth_setup.sh
```
- Compile autogenerated code (located at $AUTOGEN_P4) with p4c:
```
$P4CPATH/build/p4c-bm2-ss $AUTOGEN_P4 -o $JSON_TARGET
```
- Start the simple_switch target with the autogenerated p4 code:
```
$> sudo $BMV2PATH/targets/simple_switch/simple_switch -i 0@veth2 1@veth4 --log-file switch.log --log-flush --pcap $JSON_TARGET
```
Note that --pcap creates two pcap files (named veth2.pcap and veth4.pcap) for every switch it sends out of ports 0 and 1, respectively.
To run traffic from pre-existing pcap files, add the `--use-files 0` flag and place the input packets into veth2_in.pcap and veth4_in.pcap.

- If not using input pcap files, run traffic through the switch, i.e. `sudo python gen_sample_traffic.py`. This can also be done from the
scapy interactive shell if you're only sending a few packets.

- Start the command-line Thrift CLI and read the register values for keys and values. Feed the result into `read_registers.go` to
pretty print the resulting key / value pairs:
```
$BMV2PATH/tools/runtime_CLI.py < CLI_commands.txt | go run read_registers.go --sub-key-size=8 --key-size=16 --value-size=16 > output.txt
```
See the code for explanation of command-line flags.

To come: diffs of the autogenerated p4 code with a simulator, to verify correctness.
